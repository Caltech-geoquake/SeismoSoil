\documentclass[11pt,letterpaper]{article}
\usepackage{jshbasic}
\usepackage{jshmaths}

\usepackage{multirow}
\usepackage{wrapfig}

\graphicspath{ {./figures/} }

\definecolor{lightgray}{gray}{0.83}

\newcommand{\panel}[1]{\colorbox{lightgray}{\textsf{#1}}}

\setcounter{tocdepth}{3}

\title{\textbf{\textsf{\huge{GATechSRA Tutorial and Manual}}}}
\author{{\textsf{\Large{Dominic Assimaki}}}\thanks{Dr.~Dominic~Assimaki, Associate Professor, Department of Civil and Environmental Engineering, Georgia Institute of Technology. E-mail: \href{mailto:dominic@gatech.edu}{\textsf{dominic@gatech.edu}}; Website: \href{http://www.geoquake.gatech.edu}{\textsf{http://www.geoquake.gatech.edu}}} \and {\textsf{\Large{Wei Li}}}\and {\textsf{\Large{Jian Shi}}}\thanks{Jian Shi, Graduate Research Assistant, Department of Civil and Environmental Engineering, Georgia Institute of Technology. E-mail: \href{mailto:shijian@gatech.edu}{\textsf{shijian@gatech.edu}}}}
\date{}

\begin{document}
  \maketitle

GATechSRA is a site-specific response analysis software application, which performs 1-D linear elastic, equivalent linear, and nonlinear site response analyses. This document is the user tutorial and technical manual of GATechSRA.

%System requirements\\
%Operating system: 64-bit Windows (Mac and Linux versions are on their way)\\
%Available disk space: 3 GB (please also note that the output files are fairly large)\\
%Note: MATLAB Compiler Runtime is required to run GATechSRA (see Section 2)\\

\newpage
\tableofcontents

\newpage
\section{Introduction}

GATechSRA is a one-dimensional (1D) \textbf{\emph{{S}}}ite-specific \textbf{\emph{{R}}}esponse \textbf{\emph{{A}}}nalysis simulation and visualization application.

\subsection{Main features}
%The main features of GATechSRA includes the following:
\begin{itemize}
    \item \textbf{\textsf{Linear analysis}}
        \begin{itemize}
            \item Frequency domain analysis, which performs the most basic and simplest type of analysis, following the Haskell-Thompson formulation
            \item Time domain analysis, useful when the ``wrap-around'' phenomenon of Fourier transform is pronounced and needs to be addressed
        \end{itemize}
    \item \textbf{\textsf{Equivalent linear analysis (frequency domain)}}
        \begin{itemize}
            \item Traditional method, which follows the original equivalent linear algorithm
            \item Frequency dependent moduli and damping method
        \end{itemize}
    \item \textbf{\textsf{Nonlinear analysis (time domain)}}
        \begin{itemize}
            \item Uses the traditional Masing hysteretic rule (denoted as \emph{H2}), or
            \item Uses Muravskii hysteresis model (denoted as \emph{H4})
            \item Provides built-in tools for doing \emph{H2} and \emph{H4} curve fitting
        \end{itemize}
    \item \textbf{\textsf{Auto-generation of modulus reduction and damping curves}}
        \begin{itemize}
            \item Generates $G/G_{\text{max}}$ and damping curves directly from the soil property profile
            \item Based on the formulae proposed by Darendeli
        \end{itemize}
    \item \textbf{\textsf{Various tools that aid the simulation of site response}}
        \begin{itemize}
            \item Baseline correction, digital signal filtering
            \item Motion deconvolution, response spectra calculations, etc.
        \end{itemize}
    \item \textbf{\textsf{Fast and Easy-to-use graphical user interface}}
        \begin{itemize}
            \item The GUI is intuitive and self-explanatory
            \item Computation speed of GATechSRA is very fast, even for nonlinear analysis
            \item All input and output data files are in plain text format, and can be pasted directly from/to Excel
            \item Figures generated can be directly saved to the hard drive
        \end{itemize}
\end{itemize}

%It offers the following options: frequency domain linear viscoelastic, equivalent linear, and finite difference time domain linear and nonlinear analyses. For the latter, it has built-in frequency independent damping for low strains, and automatic model parameter fitting to the nonlinear dynamic soil properties ($G/G_{\max}$ and damping).

%In addition, GATechSRA offers motion deconvolution from rock outcrop to borehole (through viscoelastic layered bedrock), and allows input motion definition in three ways: (i) borehole motion (also known as motion ``within'' or total motion at depth); (ii) incident motion at depth (free of downgoing waves, useful for integration of site response in seismological model predictions); and (iii) rock outcrop (RO) motion; if the rock outcrop site has its separate site response (that is to say, for stations on the surface of viscoelastic homogeneous or layered media), motion should be deconvolved from RO to incident before performing site response.

%The toolbox also includes functions such as Fourier and Elastic Response Spectra, Arias Intensity, linear transfer functions, baseline correction and signal filtering (low pass, high pass and band pass filters).

%Output results include ASCII files of acceleration, velocity, displacement, stress and strain time histories at each layer, and maximum values with depth; visualization output includes time histories, Fourier and response spectra of ground motion on the surface, and maximum acceleration, velocity, displacement, stress and strain with depth.

\newpage
\subsection{Functionality structure}

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=.99\textwidth]{functionality_structure.pdf}\\
  %\caption{}\label{}
\end{figure}

%\newpage
\section{User Tutorial}
\subsection{Installation}

GATechSRA requires no installation, but because it is written in MATLAB, the users need to install MCR (MATLAB Compiler Runtime) on their computers first. MCR is readily provided by MathWorks for free\footnote{\href{http://www.mathworks.com/products/compiler/mcr}{\textsf{http://www.mathworks.com/products/compiler/mcr}} (please choose ``R2013a, 64-bit'')}. The users only need to install MCR once, before launching GATechSRA for the first time. Installing of MCR requires administrator privilege, however, running GATechSRA does not.

The system requirement of GATechSRA is: 64-bit Windows operation system, with enough disk space (recommended 3~GB) for installing MCR and storing output files. There is no requirement for minimum CPU and memory, but GATechSRA runs much faster on more advanced machines. Mac and Linux versions are currently in preparation and will be available soon.

Please keep the four auxiliary files, \emph{\textsf{TDLinear}}, \emph{\textsf{FDEQ}}, \emph{\textsf{NLH2}} and \emph{\textsf{NLH4}}, in the same directory as \\\emph{\textsf{{GATechSRA.exe}}}.
%Launching of \emph{\textsf{GATechSRA.exe}} for the first time will be slower than subsequent launches.
The screenshot of the \panel{main} panel of GATechSRA, shown below, will appear after startup.

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=.7\textwidth]{main.png}\\
  %\caption{}\label{}
\end{figure}

\newpage
\subsection{Input files preparation}

Input file examples are provided in the folder ``Sample Input Files''. Users can start trying GATechSRA right away using these files, or can follow the following paragraphs in this section to learn to prepare new input files.

All input files are in plain text format (for example, \textsf{.txt} files). Acceptable delimiters include spaces, commas, and horizontal tabs. The output files generated by GATechSRA will have horizontal tabs as delimiters.

\subsubsection{Ground motion}\label{sec:motion_file}

Ground motion data files that can be read by GATechSRA should have two (and only two) columns---the left column is the time vector in units of seconds, and the right column is the acceleration, in units of $\ein{m/s^2}$, gal ($=1\ein{cm/s^2}$), or $g$ ($=9.81\ein{m/s^2}$). Users can choose their corresponding unit in simulation graphical panels. There is a \panel{NGA to 2-column converter} panel under \panel{main}$\rightarrow$\panel{tools}, which converts the~\textsf{.AT2} format used by PEER/NGA database into the 2-column format.

\panel{Main}$\rightarrow$\panel{tools}$\rightarrow$\panel{ground motion plotter} provides plots of acceleration time history, as well as velocity and displacement time histories, which are integrated from the acceleration. Arias intensity and RMS acceleration can also be calculated. An example output of the \panel{ground motion plotter} is shown below.

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=.5\textwidth]{ground_motion_plot.png}\\
  %\caption{}\label{}
\end{figure}

Under \panel{main}$\rightarrow$\panel{tools}, users can also find \panel{signal filter} and \panel{baseline correction}, which filter or baseline-correct the ground motion accelerations; in addition, they can plot the Fourier spectra with \panel{Fourier transform} and elastic response spectra (with any damping ratio value) with \panel{elastic response spectra}. An example of the baseline correction output is shown below.

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=.99\textwidth]{baseline_correction_results.png}\\
  %\caption{}\label{}
\end{figure}

\subsubsection{Soil profile}\label{sec:soil_profile}

The input file containing the soil property profile should be in the following five-column format:

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=.62\textwidth]{profile_file.png}\\
  %\caption{}\label{}
\end{figure}

From left to right, the columns mean: soil layer thickness (m), shear wave velocity $V_s$ (m/s), low-strain damping ratio, $\xi$, soil mass density, $\rho$, and ``material number'', respectively. The units of $\xi$ can be either \% or unity (i.e., 1), and the unit of $\rho$ can be either $\ein{g/cm^3}$ or $\ein{kg/m^3}$. The users can specify the units of $\xi$ and $\rho$ on the simulation panels, before the analysis starts. The last thickness value \emph{should always be 0}, which indicates the last layer (i.e., the halfspace) has infinite depth.

The fifth column, the ``material number'', should be a series of positive integers, not necessary in a continuous and ascending order, with the exception of the last value, which \emph{should always be 0}. The material number refers to the nonlinear dynamic soil parameters, namely the $G/G_{\max}$ and damping curves. For example, the layers with ``material number''=5 correspond to the 5th set of $G/G_{\max}$ and damping curves in the ``curve file'', which will be explained in \ref{sec:curve}.

The soil profile can be manually entered through \panel{main}$\rightarrow$\panel{profile preparation}$\rightarrow$\panel{manually enter Vs profile}. A screenshot of this panel is shown below.  Alternatively, users can prepare the input files in external applications like Excel or Notepad, and save them as plain text files.

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=.99\textwidth]{profile_prepare.png}\\
  %\caption{}\label{}
\end{figure}

\subsubsection{Nonlinear dynamic soil properties: $G/G_{\max}$ and $\xi$ (damping ratio) curves}\label{sec:curve}

The two input files mentioned in \ref{sec:motion_file} and \ref{sec:soil_profile} are the only files required for linear site response analysis. For the equivalent linear and nonlinear analyses options, dynamic soil properties $G/G_{\max}$ and $\xi$ of soils are required. In GATechSRA, these properties are specified in a single text file (the ``curve file'').

Below is the format of a ``curve file''. The headers are just for demonstration and should not be included in the actual ``curve file''.

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=.81\textwidth]{curve_file_format.png}\\
  %\caption{}\label{}
\end{figure}

Each group of four columns corresponds to the dynamic nonlinear soil properties of one material: $G/G_{\max}$ and $\xi$ vs shear strain. The material number, $k$, on the fifth column of the input soil profile file corresponds to the $k$-th set of 4 columns in the ``curve file''.

In \panel{main}$\rightarrow$\panel{profile preparation}$\rightarrow$\panel{dynamic soil properties}, the $G/G_{\max}$ curves and $\xi$ curves can be automatically calculated using M.~B.~Darendeli's (2001)\footnote{Darendeli, M.~B.~(2001). ``Development of a new family of normalized modulus reduction and material damping curves.'' Pages 220--272, \emph{PhD thesis}, University of Texas at Austin.} formulae. The assumptions are:
\begin{itemize}
\item Total stress analysis (deep groundwater table)
\item PI (plasticity index) = 20\%
\item OCR: 1.0 (normally consolidated)
\item $N$ (number of cycles): 10
\item $f$ = 1 Hz
\end{itemize}

Thus, the only variable that governs the nonlinear dynamic soil properties is the overburden pressure, which is internally calculated using mass density and depth information.

The ground motion, soil profile and nonlinear dynamic soil properties are the necessary input files for equivalent linear analyses. For nonlinear analyses, the users should also specify the constitutive model parameters, as will be discussed in \ref{sec:para}.

\subsubsection{Nonlinear constitutive soil model parameters}\label{sec:para}

%The constitutive soil model in GATechSRA is the generalized modified hyperbolic model (MKZ), originally proposed by Matasovic and Vucetic (1993)\footnote{Matasovic, N., and Vucetic, M.~(1993) ``Cyclic Characterization of Liquefiable Sands.'' \emph{ASCE Journal of Geotechnical and Geoenvironmental Engineering}, 119(11), 1805--1822.} and later modified by Hayashi et al.~(1992)\footnote{Hayashi, H., M.~Honda, and T.~Yamada.~(1992) ``Modeling of nonlinear stress strain relations of sands for dynamic response analysis.'' \emph{In Proceeding: 10th World Conference on Earthquake Engineering}, Volume 11, Pages 6819--6825, Madrid, Spain, Balkema, Rotterdam.}. In addition, it includes two hysteretic rules, hereby denoted \emph{H2} and \emph{H4}.
%
%\begin{figure}[H]
%\centering
%  % Requires \usepackage{graphicx}
%  \includegraphics[width=.45\textwidth]{H2_fit.png}\\
%  %\caption{}\label{}
%\end{figure}
%
%\emph{H2} is replicates the traditional Masing rules; this means that the backbone curve is derived as the integral of the modulus degradation curve (to which MKZs parameters are calibrated) and successively, the damping of the model is derived from translated and scaled replicas of the monotonic curve. This ensures perfect fitting of the modulus degradation curve, and overestimates the damping at large strains (see the figure above).
%
%\emph{H4} on the other hand is based on an extension of the Muravskii (2005)\footnote{Muravskii, G.~(2005) ``On description of hysteretic behavior of materials.'' \emph{International Journal of Solids and Structures}, Vol.~42, Nos.~9--10, 2625--2644.} hysteresis model, which updates the parameters of unloading and reloading at each stress reversal to match the damping vs strain curve, independently of the monotonic parameters. However, this approach has been shown to cause numerical instabilities and spurious high frequency resonances at large strains. In our version, the unload-reload parameters are calibrated once for the same functional form as the monotonic loading, prior to the analysis, and are thereafter kept constant during the simulations. This process is done in stages; first we fit the modulus reduction, and then the damping parameters (see the figure below). Successively, when the model is loaded, the constitutive law uses the loading parameters, and during unloading it uses the unloading parameters that are calibrated from the damping curve (see the figure below). While this approach compromises the fitting between model and experimental results, it has been shown to perform much better than the Muravskii alternative in large strains.
%
%\begin{figure}[H]
%\centering
%  % Requires \usepackage{graphicx}
%  \includegraphics[width=.80\textwidth]{H4_fit.png}\\
%  %\caption{}\label{}
%\end{figure}
%
%In general, we recommend the use of \emph{H2} for intermediate strain problems ($10^{-2}$) and the use of \emph{H4} for large strain ($>10^{-2}$) problems.
%\texttt{H2\_n.txt} is the input file for \emph{H2}, and \texttt{H4\_G.txt} and \texttt{H4\_x.txt} are the input files for \emph{H4} (two sets of parameters).

Apart from the ground motion, soil profile, dynamic curves, the nonlinear analysis in GATechSRA requires additional information---the constitutive soil parameters. The \emph{H2} nonlinear method requires one file, \textsf{H2\_n.txt}, and the \emph{H4} nonlinear method requires two files, \textsf{H4\_G.txt} and \textsf{H4\_x.txt}.  These files have the same format, which looks like below (actual input files should not have the table headers):

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=.52\textwidth]{H2_n_format.png}\\
  %\caption{}\label{}
\end{figure}

Each column of the file corresponds to a set of 4 columns in the ``curve file'', and in the same order as the ``curve file''. $\gamma_{\text{ref}}$ is the reference strain, and $s$ and $\beta$ are the two parameters in the MKZ model. These three parameters are obtained by curve-fitting the two predefined hysteretic models (\emph{H2} and \emph{H4}).

Curve fitting can be done using the \panel{main}$\rightarrow$\panel{profile preparation}$\rightarrow$\panel{nonlinear curve fitting} panel (shown in the figure below), which takes a ``curve file'' as the input, and generates a \textsf{H2\_n.txt} file (using \emph{H2} curve fitting) or \textsf{H4\_G.txt} and \textsf{H4\_x.txt} files (using \emph{H4} curve fitting).

The details of the two hysteretic models and these curve-fitting parameters will be explained in Section~\ref{sec:manual}, the technical manual.


\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=.60\textwidth]{nonlinear_curve_fitting.png}\\
  %\caption{}\label{}
\end{figure}

%Select the ``curve file'', and click either \colorbox{lightgray}{H2 fitting \& save} or \colorbox{lightgray}{H4 fitting \& save}. Because the curve fitting uses an optimization scheme (genetic algorithm with local hill climbing), it is generally slow.

\newpage
\subsection{Run the simulation}

The input files necessary for different kinds of simulations are summarized below.

\begin{small}
\begin{table}[H]
    \centering
%  \caption{}\label{}
    \begin{tabular}{|c|c|c|c|c|c|c|c|}
         \hline
         & & profile & motion & curve & H2\_n & H4\_G & H4\_x \\
         \hline
        \multirow{2}{*}{Linear} & frequency domain & \checkmark & \checkmark &   &   &  & \\
        \cline{2-8}
         & time domain & \checkmark & \checkmark &   &   & &\\
         \hline
         \multirow{2}{*}{Equivalent linear} & traditional & \checkmark & \checkmark & \checkmark  &   &   &\\
        \cline{2-8}
         & frequency dependent & \checkmark & \checkmark & \checkmark &   &  &\\
         \hline
         \multirow{2}{*}{Nonlinear} & H2 & \checkmark & \checkmark & \checkmark  & \checkmark  &   &\\
        \cline{2-8}
         & H4 & \checkmark & \checkmark & \checkmark &   & \checkmark & \checkmark \\
         \hline
    \end{tabular}
\end{table}
\end{small}


%For linear analyses, the user needs only the soil profile and the input motion. For equivalent linear analysis, the user needs the soil profile, the soil curves file, and the input motion. For nonlinear analysis with Masing rules (\emph{H2}), the users need the soil profile, curves file, \texttt{H2\_n} file, and the motion; and with modified hysteretic rule (\emph{H4}), the users need the soil profile, curves file, \texttt{H4\_G} file, \texttt{H4\_x} file, and the input motion.

%The screenshot below is the panel for a nonlinear \emph{H4} analysis. Follow each steps indicated on the panel, import all necessary input files, and click \colorbox{lightgray}{Start}. You can adjust the name of the soil profile, some of the input units, choose a baseline correction option, and select the output directory. The user is advised to carefully choose the type of bedrock (elastic or rigid) and the location that the input motions are prescribed or incident or recorded. Please refer to Section 5 for more details.

The user interface for linear analysis is shown below. The users can follow ``step 1'' to ``step 3'' on the panel and import the corresponding data. And then the users can click \textsf{Start} to start the calculation. Time-domain and frequency-domain linear methods both have the same user interface.

Please note that in Step 1.2 and Step 3.2, bedrock type and motion type should be chosen. Careful consideration is strongly recommended here, since different combinations of these two can lead to rather different results.  Please refer to the notes in Section~\ref{sec:bedrock-type-and-motion-location} on page \pageref{sec:bedrock-type-and-motion-location} for a detailed explanation of how to make the choice.

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=0.99\textwidth]{linear_panel.png}\\
  %\caption{}\label{}
\end{figure}


\newpage
The user interface for equivalent linear (traditional and frequency dependent) methods is shown below. Similarly to the linear analysis, the users can follow the procedures indicated on the panel and import the corresponding data.

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=0.99\textwidth]{equivalent_linear_panel.png}\\
  %\caption{}\label{}
\end{figure}

\newpage
The user interface for \emph{H4} nonlinear analysis is shown below. The users should have no problem following the procedures indicated on the panel and import the corresponding data. The interface for \emph{H2} nonlinear analysis differs slightly with \emph{H4}, only in ``step 3'', where \emph{H2} only requires one input file, namely, \textsf{H2\_n.txt}.

\begin{figure}[H]
\centering
  % Requires \usepackage{graphicx}
  \includegraphics[width=0.99\textwidth]{H4_panel.png}\\
  %\caption{}\label{}
\end{figure}


\newpage
\subsubsection{Notes on bedrock type and input motion location}\label{sec:bedrock-type-and-motion-location}

GATechSRA has two options of bedrock in the numerical scheme: rigid and elastic. It also accepts three types of input motion: incident motion at the bedrock, total motion at the bedrock (or borehole recorded motion, or sometimes referred as the ``within motion''), and total motion on rock outcrop---as shown in the figure below. So there are six combinations:

\noindent\textbf{A)	Borehole recorded motion, with:}
\vspace{-10pt}
\begin{enumerate}
\item \textbf{Rigid bedrock} -- suitable when the borehole motion is known and prescribed
\item \textbf{Elastic bedrock} -- for this combination, the software generates a error message and does not do the simulation. Because elastic/viscoelastic bedrock means that the rock outcrop site has its own site response. The traditional approach of dividing the motion by 2 and using it as incident, or directly using the rock outcrop motion as total motion at the base of the profile are not correct and should be avoided if needed. The users are encouraged to remove this response by performing rock outcrop deconvolution to the incident motion, and then run the analysis with other appropriate motion-bedrock combinations.
\end{enumerate}

\begin{wrapfigure}{r}{0.45\textwidth}
\begin{center}
  % Requires \usepackage{graphicx}
  \includegraphics[width=0.45\textwidth]{three_motion_types.png}\\
  %\caption{}\label{}
\end{center}
\end{wrapfigure}

\noindent\textbf{B) Incident motion, with:}
\vspace{-10pt}
\begin{enumerate}
\item \textbf{Rigid bedrock} -- in this case, the borehole motion, i.e., the total motion, is equal to the outcrop motion, and twice the incident motion
\item \textbf{Elastic bedrock} -- in this case, the input motion is the borehole motion free of downgoing waves
\end{enumerate}

\noindent\textbf{C) Rock outcrop motion, with:}
\vspace{-10pt}
\begin{enumerate}
\item \textbf{Rigid bedrock} -- this combination is identical to combination A1
\item \textbf{Elastic bedrock} -- use with caution: the actual motion at the soil-rock interface is slightly different from the outcrop motion, so it is recommended that the users deconvolve the rock outcrop motion to incident motion, and use combination B2
\end{enumerate}

The choice of different combinations affects how GATechSRA calculates the site response, and thus the results of simulations. Figure~\ref{fig:three-types-of-TF} on page \pageref{fig:three-types-of-TF} shows three different types of linear amplification factors corresponding to different choices of bedrock-motion combinations.





\newpage
\subsection{Interpretation of output files}

The output data files include the following (assuming the input motion name is M1):

\begin{small}
\begin{itemize}
\item \textsf{M1\_accel\_on\_surface.txt} - Acceleration time history on ground surface. Two columns: time array (on the left) and acceleration (on the right).
\item \textsf{M1\_max\_a\_v\_d.txt} - Maximum acceleration, velocity, and displacement of each layer
\item \textsf{M1\_max\_gamma\_tau.txt} - Maximum strain and stress of each layer
\item \textsf{M1\_nonlinear\_TF\_raw.txt} - Nonlinear transfer function (absolute value, and unprocessed). Two columns: frequency array (on the left) and amplification factor (on the right)
\item \textsf{M1\_nonlinear\_TF\_smoothed.txt} - Nonlinear transfer function (absolute value, smoothed, using Konno-Ohmachi algorithm\footnote{Please refer to Section~\ref{sec:konno-ohmachi} on page \pageref{sec:konno-ohmachi} for details of the Konno-Ohmachi smoothing algorithm}). The format is the same as the raw transfer function.
\item \textsf{M1\_re-discretized\_profile.txt} - Re-discretized soil profile used internally in the simulation, usually finer than the original\footnote{Please refer to Section~\ref{sec:rediscretization} on page \pageref{sec:konno-ohmachi} for details of layer re-discretization.}
\item \textsf{M1\_time\_history\_accel.txt} - Acceleration time history of every layer. Each column represents the time history of one layer. And the columns from left to right represent the soil layers from the surface to the bedrock. The time array is not included.
\item \textsf{M1\_time\_history\_veloc.txt} - Velocity time history of every layer. Format same as above.
\item \textsf{M1\_time\_history\_displ.txt} - Displacement time history of every layer. Format same as above.
\item \textsf{M1\_time\_history\_strain.txt} - Strain time history of every layer. Format same as above.
\item \textsf{M1\_time\_history\_stress.txt} - Stress time history of every layer. Format same as above.
\end{itemize}
\end{small}

There are also three~\textsf{.png} figures corresponding to the data files.

The units of the output files: the units of results are SI units (sec, Hz, m, m/s, m/s/s, and Pa), and the unit of the output strains is 1 (not \%).


\newpage
\section{Technical Manual}\label{sec:manual}

\subsection{Linear approach}\label{sec:linear}

In linear approach, the soil is assumed as a Kelvin-Voigt solid, whose dynamic behavior is is described using a purely elastic spring and a purely viscous dashpot\footnote{Kramer, 1996}, having two defining parameters, $G$ (soil modulus) and $\xi$ (soil damping ratio). Linear approach assumes $G$ and $\xi$ to remain unchanged in dynamic processes, which is not the case, especially when the ground motion intensity is strong.

\subsubsection{Frequency domain linear approach}

In frequency domain linear analysis, the amplification of ground motions by the soil layers are computed via transfer functions, using the following formula,
\begin{equation}\label{eq:freq-domain-amplification}
    a_{\text{out}}\left(t\right)=\text{IFT}\left[H\left(\omega\right)\cdot\text{FT}\left[a_{\text{in}}(t)\right]\right]
\end{equation}
where $a_{\text{in}}(t)$ and $a_{\text{out}}$ are the input and output ground motions in time domain, FT[ ] and IFT[ ] represent Fourier transform and inverse Fourier transform, and $H(\omega)$ is the complex-valued transfer function in frequency domain, which can be solely determined by the soil property profile.

The following paragraphs show the derivation of $H(\omega)$ from the soil properties.

Let $ j $ denote the soil layer index, and $ A_j $ and $ B_j $ the upgoing and downgoing SH wave displacement amplitudes at the $ j $-th layer.  In this case, the following relationship holds for every $ j $:
\begin{equation}
 \left\{\begin{array}{c}
A_{j+1} \\
B_{j+1}
\end{array} \right\} = \left[\begin{array}{cc}
\f{1}{2}(1+\alpha^*_j)\mrm{e}^{ik^*_jh_j} & \f{1}{2}(1-\alpha^*_j)\mrm{e}^{-ik^*_jh_j} \\
\f{1}{2}(1-\alpha^*_j)\mrm{e}^{ik^*_jh_j} & \f{1}{2}(1+\alpha^*_j)\mrm{e}^{-ik^*_jh_j}
\end{array} \right]\cdot \left\{\begin{array}{c}
A_j \\
B_j
\end{array} \right\}  \eqdef \mathbf{D}_j\cdot \left\{\begin{array}{c}
A_j \\
B_j
\end{array} \right\}
\end{equation}
where $ \alpha_j^* = \displaystyle\f{\rho_j V^*_{s,j}}{\rho_{j+1} V^*_{s,j+1}}$ is the complex impedance ratio of two successive layers $ j $ and $ (j+1) $;  \newline $ V^*_{s,j} = V_{s,j}\cdot\sqrt{1+2i\xi_j}$ is the complex shear wave velocity of layer $ j $; $ h_j $ is the thickness of layer $ j $; and $ k^*_j = \displaystyle\f{\omega}{V^*_{s,j}} = \f{k_j}{1+i\xi_j}$ is the complex wave number of layer $ j $, where $ \omega $ is the angular frequency.

Hence
\begin{equation}
	\left\{\begin{array}{c}
A_j \\
B_j
\end{array} \right\} = \mathbf{D}_{j-1} \left\{\begin{array}{c}
A_{j-1} \\
B_{j-1}
\end{array} \right\} = \mathbf{D}_{j-1}\mathbf{D}_{m-2}\left\{\begin{array}{c}
A_{j-2} \\
B_{j-2}
\end{array} \right\} = \cdots = \mathbf{D}_{j-1}\mathbf{D}_{j-2}\cdots\mathbf{D}_{1}\left\{\begin{array}{c}
A_{1} \\
B_{1}
\end{array} \right\}
\label{eq:j_to_1}
\end{equation}
where $ A_1 = B_1 = S/2 $, and $ S $ is the total surface displacement amplitude.

Let $ \mathbf{E}_{j-1} = \mathbf{D}_{j-1}\mathbf{D}_{j-2}\cdots\mathbf{D}_{1} $, thus Equation~\eqref{eq:j_to_1} becomes
\begin{equation}\label{eq:j-to-1b}
\left\{\begin{array}{c}
A_j \\
B_j
\end{array} \right\} = \mathbf{E}_{j-1}\left\{\begin{array}{c}
A_1 \\
B_1
\end{array} \right\}  = \left[\begin{array}{cc}
E_{j-1}^{\langle 11\rangle} & E_{j-1}^{\langle 12\rangle} \\
E_{j-1}^{\langle 21\rangle} & E_{j-1}^{\langle 22\rangle}
\end{array} \right]\left\{\begin{array}{c}
S/2\\
S/2
\end{array} \right\}
\end{equation}

Equation~\eqref{eq:j-to-1b} relates the displacement amplitudes at the top of the $j$-th layer to the layer on ground surface. Using this equation we can also relate the displacement amplitudes of any two layers, $j$ and $k$,
\begin{equation}
    \left\{\begin{array}{c}
    A_j \\
    B_j
    \end{array} \right\} = \mathbf{E}_{j-1}\cdot\mathbf{E}_{k-1}^{-1}\cdot\left\{\begin{array}{c}
    A_k \\
    B_k
    \end{array} \right\}
\end{equation}
And if $m$ is the total number of soil layers (excluding the underlying bedrock), the displacement amplitudes between the top of bedrock and the top of ground surface is
\begin{equation}\label{eq:m-to-1}
\left\{\begin{array}{c}
A_m \\
B_m
\end{array} \right\} = \mathbf{E}_{m-1}\left\{\begin{array}{c}
A_1 \\
B_1
\end{array} \right\}  = \left[\begin{array}{cc}
E_{m-1}^{\langle 11\rangle} & E_{m-1}^{\langle 12\rangle} \\
E_{m-1}^{\langle 21\rangle} & E_{m-1}^{\langle 22\rangle}
\end{array} \right]\left\{\begin{array}{c}
S/2\\
S/2
\end{array} \right\}
\end{equation}

Referring to Figure~\ref{fig:three-types-of-input-motions}, three types of transfer functions can be written,


\begin{figure}[h]
    \centering
  \includegraphics[width=0.45\textwidth]{three_motion_types.png}\\
  \caption{Three types of input motions}\label{fig:three-types-of-input-motions}
\end{figure}

\textsf{(A)} The ``surface to borehole'' (surface motion to total borehole motion) transfer function:
\begin{equation}
H_{\text{A}}(\omega)  = \displaystyle\frac{\text{Ampl}(u_1)}{\text{Ampl}(u_{m-\text{(total)}})} = \frac{S/2 + S/2}{A_m+B_m} = \frac{2}{E_{m-1}^{\la 11\ra} + E_{m-1}^{\la 12\ra}+E_{m-1}^{\la 21\ra} + E_{m-1}^{\la 22\ra}}
\end{equation}
%and the absolute value of $H_{\text{A}}(\omega)$ is the amplification factor
%\begin{equation}
%\mathrm{AF}_{\txt{S-BH}}(\omega) = |\mathrm{TF}_{\txt{S-BH}}(\omega)| = \f{2}{\left|E_{N-1}^{\la 11\ra} + E_{N-1}^{\la 12\ra}+E_{N-1}^{\la 21\ra} + E_{N-1}^{\la 22\ra}\right|}
%\end{equation}

\textsf{(B)} The ``surface to incident'' (surface motion to incident motion at borehole) transfer function is
\begin{equation}
H_{\text{B}}(\omega) = \f{S/2+S/2}{A_m} =\f{2}{E_{m-1}^{\la 11\ra} + E_{m-1}^{\la 12\ra}}
\end{equation}

\textsf{(C)} The ``surface to rock outcrop'' (motion at soil surface to motion at rock outcrop site's surface) transfer function is
\begin{equation}
H_{\text{C}}(\omega) = \f{S/2+S/2}{2A_m} = \f{1}{E_{m-1}^{\la 11\ra} + E_{m-1}^{\la 12\ra}}
\end{equation}

The three types of amplification functions of a same site, plotted together on the same graph, are shown in Figure~\ref{fig:three-types-of-TF}.

\begin{figure}[h]
    \centering
  \includegraphics[width=0.6\textwidth]{three_types_of_TF.pdf}\\
  \caption{Three types of linear transfer functions}\label{fig:three-types-of-TF}
\end{figure}




\subsubsection{Time domain linear approach}

The time domain linear approach solves the wave propagation functions directly in the time domain, using the finite difference scheme. The soil properties remain unchanged during the entire duration of shaking. In order to incorporate $G$ and $\xi$ information from the input into the time domain scheme, a numerical model aiming at approximating the frequency independent damping behavior of soil is used. The degree of approximation is satisfactory, however not perfect. Therefore there is a slight difference between the result of frequency domain linear approach and time domain linear approach.

The merit of time domain linear approach is that it prevents the ``wrap-around'' phenomenon that frequency-domain linear approach sometimes has. Because of the underlying assumption of Fourier transform, that the signal in time domain being transformed ``starts from the beginning of time and lasts forever'', the response that corresponds to the end of the input ground motion appears at the beginning part of the output ground motion, i.e., ``wrapped-around''.  This phenomenon is especially pronounced when the input ground motion is synthetic and short, e.g., a Ricker wavelet.

For more details concerning how the temporal-spatial finite difference is carried out, please refer to Section~\ref{sec:nonlinear} on page \pageref{sec:nonlinear}.


\subsection{Equivalent linear approach}\label{sec:equivalent-linear}

\subsubsection{Traditional equivalent linear approach}

The equivalent linear approach, first used in the computer program SHAKE (Schnabel et al., 1972; Idriss \& Sun, 1992), is a modified linear approach which partly incorporates the nonlinear properties of soil. This approach accepts that modulus and damping of soil in a dynamic process are no longer the same as their initial values, which are $G_{\text{max}}$ and $\xi_{\text{small strain}}$. In order to determine the appropriate values for $G$ and $\xi$, the equivalent linear approach calculates linear site response (in frequency domain) once, obtaining the strain time histories at the center of each soil layer. Then, an ``effective'' strain value is picked for each layer, which is subsequently used to obtain an updated $G$ value and an updated $\xi$ value from the modulus reduction and damping curves. Linear site response is carried out once more, obtaining updated strain time histories and effective strains, which are used to update $G$ and $\xi$ again.  This process is repeated until convergence. The ground response after convergence is the result of the equivalent linear approach.

The detailed procedure of the equivalent linear approach in GATechSRA is as follows.
\begin{enumerate}
    \item Re-discretize the existing soil layers based on shear wave velocities of each layer (for details, see Section~\ref{sec:rediscretization} on page \pageref{sec:rediscretization})
    \item Calculate linear transfer functions between each intermediate layer and the input point (can either be ``borehole'', or ``incident'', or ``outcrop'')
    \item Use Equation~\eqref{eq:freq-domain-amplification} to calculate acceleration time histories on the top of each soil layer
    \item Integrate acceleration time histories twice to get displacement time histories
    \item Use the displacements between two neighboring layers to calculate the approximate strain time histories at the mid-point of each layer
    \item Pick 65\% of the maximum absolute strain as the ``effective'' strain (for every layer)
    \item Pick updated $G$ and $\xi$ values according to the ``effective'' strains of each layer
    \item Check if the relative differences between two successive $G$ and $\xi$ values fall below 7.5\% (for every layer)
    \item If true, end the iteration; of not, repeat steps 2--8
    \item After 10 iterations, break out of the loop, regardless of convergence
\end{enumerate}

The equivalent linear approach does not reflect the real-world soil behavior in that it assumes constant $G$ and $\xi$ values for each layer, during the entire duration of the dynamic response. In fact, modulus and damping of soil change instantaneously with the strain level that the soil has. Also, different frequency components in the input motion are associated with different strain levels, thus increasing damping values indiscriminatively causes the high frequency components in a ground motions, which are usually not as intense as the low frequency ones, to attenuate excessively. This is especially obvious for deep and soft sites.

An example of linear, equivalent linear and true amplification factors is shown in Figure~\ref{fig:af_comparison}. The true amplifications factor is calculated from actual surface and borehole seismographs. From the figure, we can see that how much equivalent linear approach overdamps the high frequency components, and how linear approach might overestimate ground response at some particular frequencies.

\begin{figure}[h]
    \centering
  \includegraphics[width=0.6\textwidth]{amplification_factor_comparison.pdf}\\
  \caption{Comparison of amplifications factors}\label{fig:af_comparison}
\end{figure}








%Modulus and damping curves of soils are used to determine new parameters for each soil layer. The frequency domain linear approach, same as previously discussed in Section~\ref{sec:linear}, is repeated to get an updated displacement time history and strain time history



%, and iterations are performed until convergence. This stepwise analysis procedure has been formalized into a computer code termed SHAKE \citep{Schnabel1972SHAKE}, which currently is the most widely used analysis package for 1D site-specific response calculations. The advantages of the equivalent-linear approach are that the mathematical simplicity of linear analysis is preserved and the determination of nonlinear parameters is avoided.

%Despite the effectiveness of the approach for the analysis of relatively stiff sites subjected to inter-mediate levels of strain (<$10^{-3}$), however, the equivalent linear method has been shown to overestimate the peak ground acceleration for large events, and artificially suppress the high frequency components when applied for the analysis of deep sites. An alternative methodology that accounts for the frequency-dependence of strain amplitudes and associated dynamic soil properties has been proposed by \citet{Assimaki_Kausel_2002}, and has been shown to yield more satisfactory results for deep sedimentary deposits; the applicability of the alternative formulation, however, is still limited to the medium strain levels \citep{Hartzell2004BSSA}.
%The linear stress-strain material behavior and total stress approach associated with equivalent linear models, entirely prohibits their use for problems that involve large levels of strain (e.g. near-fault motions), deep and/or soft and very soft sedimentary sites. We here implement only the original formulation of the equivalent linear method for ground surface response analyses at each station to the ensemble of ground motion time-histories. Comparison of the equivalent linear analyses results to the fully nonlinear response described below reveals the drawbacks of equivalent linear analyses associated with overdamping of high frequency components, and highlights the sites and ground motion characteristics that dictate the use of nonlinear models for the computation of site-specific amplification factors.





\subsubsection{Equivalent linear approach with frequency dependent modulus and damping}

\subsection{Nonlinear approach}\label{sec:nonlinear}

\subsection{Miscellaneous technical details}

\subsubsection{Baseline correction}\label{sec:baseline-correction}





\subsubsection{Konno-Ohmachi smoothing of frequency spectra}\label{sec:konno-ohmachi}

Spectral ratios calculated from surface-borehole ground motion pairs of actual recordings, or from output-input accelerations of the time-domain nonlinear analysis, usually have lots of spikes due to ``discrete spectral holes'' in the Fourier spectrum at the denominator. A smoothing window applied to the spectral ratio is able to address this problem, making the spectral ratio more intuitive and understandable.

Some traditionally used of smoothing windows include uniform window and triangle window, which has the same span to the left and the right of the point to be smoothed. This type of window has the same ``smoothing intensity'' for all frequencies, which will be later referred to as the ``linear-span smoothing''

 However, since the spectral ratios are often plotted in log-frequency scales, and the spikes are usually more pronounced at higher frequencies (above 5--10~Hz), it is advantageous to use a class of smoothing windows that has the same left and right span in logarithmic scale. The Konno-Ohmachi smoothing window\footnote{Konno, K.~and T.~Ohmachi.~(1998) ``Ground-Motion Characteristics Estimated from Spectral Ratio between Horizontal and Vertical Components of Microtremor''. Bulletin of the Seismological Sociaty of Americ, Vol.~88, No.~1, pp.~228--241.} is one of this kind. The function for Konno-Ohmachi smoothing window is
\begin{equation}\label{eq:konno-ohmachi}
	w(f,f_c) = \left(   \frac{ \sin\left(  b\log_{10}(f/f_c)  \right) }{ b\log_{10}(f/f_c) }   \right)^4
\end{equation}
where $f_c$ is the frequency at which the spectral ratio will be smoothed, $f$ is the frequency variable, and $b$ is the smoothing factor which adjusts the width of $w(f,f_c)$. The larger $b$ is, the less ``intense'' the smoothing would be. In GATechSRA, the default $b$ value is $40$.

Figure~\ref{fig:different_smoothing_windows} shows a comparison of a raw (unsmoothed) spectral ratio, a linear-span smoothed, and two Konno-Ohmachi smoothed ($b=20$ and $40$). From the figure, we can see that the linear-span smoothing does not smooth the high-frequency (above 5~Hz) components enough, thus the two fundamental frequency modes cannot be clearly observed. On the other hand, Konno-Ohmachi smoothing does a better job in eliminating the spectral spikes at higher frequencies, which are mainly numerical artifacts.

However, the users should note that the choice of smoothing functions should serve the purpose of the smothing, Konno-Ohmachi smoothing is appropriate for spectral ratios, but might produce physically meaningless results for other applications.

\begin{figure}[h]
   \centering
  \includegraphics[width=0.6\textwidth]{different_smoothing_windows.pdf}\\
  \caption{Comparison of different smoothing windows}\label{fig:different_smoothing_windows}
\end{figure}




\subsubsection{Automatic re-discretization of soil layers}\label{sec:rediscretization}




\subsubsection{Deconvolution of rock-outcrop motions}\label{sec:deconvolution}









\end{document} 